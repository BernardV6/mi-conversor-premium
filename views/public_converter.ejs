<main class="container mx-auto px-6 py-12">
        <h1 class="text-4xl font-bold text-center mb-8">Convierte tus Videos y Audios</h1>

        <div class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg">
            <% if (!isPremium && conversionsLeft <= 0) { %>
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6" role="alert">
                    <strong class="font-bold">¡Límite alcanzado!</strong>
                    <span class="block sm:inline">Has usado tus <%= maxSize %> conversiones gratuitas diarias. <a href="/premium" class="font-semibold underline hover:text-red-800">Actualiza a Premium</a> para conversiones ilimitadas.</span>
                </div>
            <% } else if (!isPremium) { %>
                <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-6" role="alert">
                    <strong class="font-bold">Plan Gratuito:</strong>
                    <span class="block sm:inline">Te quedan <%= conversionsLeft %> conversiones de video/audio hoy. Tamaño máximo de archivo: <%= maxSize %>MB.</span>
                </div>
            <% } else { %>
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6" role="alert">
                    <strong class="font-bold">¡Usuario Premium!</strong>
                    <span class="block sm:inline">Disfruta de conversiones ilimitadas. Tamaño máximo de archivo: <%= maxSize %>MB.</span>
                </div>
            <% } %>

            <form id="conversionForm" enctype="multipart/form-data" class="space-y-6">
                <div>
                    <label for="videoFile" class="block text-lg font-medium text-gray-700 mb-2">Selecciona un archivo (Video o Audio)</label>
                    <input type="file" id="videoFile" name="video" accept="video/*,audio/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                    <p class="mt-1 text-sm text-gray-500">Tamaño máximo: <%= maxSize %>MB</p>
                </div>

                <div>
                    <label for="outputFormat" class="block text-lg font-medium text-gray-700 mb-2">Formato de Salida</label>
                    <select id="outputFormat" name="format" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="mp4">MP4 (Video)</option>
                        <option value="avi">AVI (Video)</option>
                        <option value="mkv">MKV (Video)</option>
                        <option value="mov">MOV (Video)</option>
                        <option value="mp3">MP3 (Audio)</option>
                        <option value="wav">WAV (Audio)</option>
                        <option value="ogg">OGG (Audio)</option>
                    </select>
                </div>

                <div>
                    <label for="quality" class="block text-lg font-medium text-gray-700 mb-2">Calidad de Video</label>
                    <select id="quality" name="quality" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="medium">Media (Recomendado)</option>
                        <option value="low">Baja (Archivos pequeños)</option>
                        <option value="high">Alta (Mayor calidad)</option>
                    </select>
                </div>

                <button type="submit" id="convertButton" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    Convertir Archivo
                </button>
            </form>

            <!-- Conversion Status -->
            <div id="statusSection" class="mt-8 hidden">
                <h2 class="text-2xl font-bold mb-4">Estado de la Conversión</h2>
                <div class="bg-gray-100 p-6 rounded-lg shadow-inner">
                    <p>Estado: <span id="conversionStatus" class="font-semibold">Iniciando...</span></p>
                    <div class="mt-4">
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="progressBar" class="bg-blue-600 h-4 rounded-full progress-bar"></div>
                        </div>
                        <p class="text-right mt-2 text-sm text-gray-600"><span id="progressPercent">0</span>% completado</p>
                    </div>
                    <p class="mt-2">Tiempo transcurrido: <span id="timeElapsed">00:00:00</span></p>
                    <p>Velocidad: <span id="conversionSpeed">N/A</span></p>
                    <div id="downloadSection" class="mt-6 hidden">
                        <a id="downloadLink" href="#" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <svg class="-ml-1 mr-2 h-5 w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            Descargar Archivo
                        </a>
                    </div>
                    <div id="errorSection" class="mt-6 hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">¡Error en la conversión!</strong>
                        <span id="errorMessage" class="block sm:inline"></span>
                        <a id="upgradeErrorLink" href="/premium" class="font-semibold underline hover:text-red-800 hidden">Actualizar a Premium</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.getElementById('conversionForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const convertButton = document.getElementById('convertButton');
            const statusSection = document.getElementById('statusSection');
            const conversionStatus = document.getElementById('conversionStatus');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const timeElapsed = document.getElementById('timeElapsed');
            const conversionSpeed = document.getElementById('conversionSpeed');
            const downloadSection = document.getElementById('downloadSection');
            const downloadLink = document.getElementById('downloadLink');
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            const upgradeErrorLink = document.getElementById('upgradeErrorLink');

            convertButton.disabled = true;
            conversionStatus.textContent = 'Subiendo archivo...';
            statusSection.classList.remove('hidden');
            downloadSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            progressBar.style.width = '0%';
            progressPercent.textContent = '0';
            timeElapsed.textContent = '00:00:00';
            conversionSpeed.textContent = 'N/A';

            try {
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    const jobId = data.jobId;
                    conversionStatus.textContent = 'Procesando...';
                    pollProgress(jobId);
                } else {
                    conversionStatus.textContent = 'Error';
                    errorMessage.textContent = data.error || 'Ocurrió un error inesperado.';
                    errorSection.classList.remove('hidden');
                    if (data.upgradeUrl) {
                        upgradeErrorLink.classList.remove('hidden');
                    } else {
                        upgradeErrorLink.classList.add('hidden');
                    }
                    convertButton.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                conversionStatus.textContent = 'Error de conexión';
                errorMessage.textContent = 'No se pudo conectar con el servidor. Inténtalo de nuevo.';
                errorSection.classList.remove('hidden');
                convertButton.disabled = false;
            }
        });

        async function pollProgress(jobId) {
            const conversionStatus = document.getElementById('conversionStatus');
            const progressBar = document.getElementById('progressBar');
            const progressPercent = document.getElementById('progressPercent');
            const timeElapsed = document.getElementById('timeElapsed');
            const conversionSpeed = document.getElementById('conversionSpeed');
            const downloadSection = document.getElementById('downloadSection');
            const downloadLink = document.getElementById('downloadLink');
            const errorSection = document.getElementById('errorSection');
            const errorMessage = document.getElementById('errorMessage');
            const convertButton = document.getElementById('convertButton');
            const upgradeErrorLink = document.getElementById('upgradeErrorLink');

            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/progress/${jobId}`);
                    const data = await response.json();

                    if (data.done) {
                        clearInterval(interval);
                        convertButton.disabled = false;

                        if (data.status === 'Completado') {
                            conversionStatus.textContent = 'Completado';
                            progressBar.style.width = '100%';
                            progressPercent.textContent = '100';
                            downloadLink.href = `/api/download/${jobId}`;
                            downloadSection.classList.remove('hidden');
                        } else {
                            conversionStatus.textContent = 'Error';
                            errorMessage.textContent = data.error || 'La conversión falló.';
                            errorSection.classList.remove('hidden');
                            if (data.upgradeUrl) {
                                upgradeErrorLink.classList.remove('hidden');
                            } else {
                                upgradeErrorLink.classList.add('hidden');
                            }
                        }
                    } else {
                        conversionStatus.textContent = data.status;
                        progressBar.style.width = `${data.progress}%`;
                        progressPercent.textContent = data.progress;
                        timeElapsed.textContent = data.time;
                        conversionSpeed.textContent = data.speed;
                    }
                } catch (error) {
                    console.error('Error polling progress:', error);
                    clearInterval(interval);
                    conversionStatus.textContent = 'Error de conexión';
                    errorMessage.textContent = 'No se pudo obtener el progreso. Inténtalo de nuevo.';
                    errorSection.classList.remove('hidden');
                    convertButton.disabled = false;
                }
            }, 2000); // Poll every 2 seconds
        }
    </script>

</body>
</html>
